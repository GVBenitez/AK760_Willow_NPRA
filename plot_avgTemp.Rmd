```{r}


library(plotly)
library(tidyr)
library(ggplot2)
library(readr)
library(dplyr)
library(tidyverse)
library(lubridate)

df1 <- read_delim("_book/dailyAvgTemp.csv", delim = "|")

data <- df1

data_long <- data %>%
  pivot_longer(cols = -c(`Water Year`, Day),
               names_to = "Month",
               values_to = "Temperature")

month_order <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

data_long <- data_long %>%
  mutate(
    Month = factor(Month, levels = month_order, ordered = TRUE),
    Date = as.Date(paste("2000", Month, Day, sep = "-"), format = "%Y-%b-%d"),
    `Water Year` = as.factor(`Water Year`),
    hover_text = paste("Water Year:", `Water Year`, "<br>",
                       "Month:", Month, "<br>",
                       "Day:", Day, "<br>",
                       "Temperature:", round(Temperature, 1), "°F")
  ) %>%
  arrange(Month, Day)

# Calculate the average temperature for each day of the year
avg_temp <- data_long %>%
  group_by(Month, Day) %>%
  summarise(AvgTemperature = mean(Temperature, na.rm = TRUE), .groups = 'drop') %>%
  mutate(
    Date = as.Date(paste("2000", Month, Day, sep = "-"), format = "%Y-%b-%d"),
    hover_text = paste("Average Temperature", "<br>",
                       "Month:", Month, "<br>",
                       "Day:", Day, "<br>",
                       "Temperature:", round(AvgTemperature, 1), "°F")
  )

# Create the combined line graph
p <- ggplot() +
  # Individual year lines
  geom_line(data = data_long, 
            aes(x = Date, y = Temperature, color = `Water Year`, group = `Water Year`, text = hover_text), 
            alpha = 0.5) +
  # Average temperature line
  geom_line(data = avg_temp, 
            aes(x = Date, y = AvgTemperature),
            color = "black", size = 1.2) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  scale_color_viridis_d(option = "plasma") +  # Color-blind friendly palette
  labs(title = "Average Daily Temperature 2004-2024",
       x = "Month",
       y = "Temperature (Fahrenheit)",
       color = "Water Year") +
  theme_minimal() +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to interactive plotly object with custom hover
p_interactive <- ggplotly(p, tooltip = "text")

# Modify hover template and mode
for (i in 1:length(p_interactive$x$data)) {
  p_interactive$x$data[[i]]$hoverinfo <- "text"
  p_interactive$x$data[[i]]$hoverlabel <- list(bgcolor = "white")
}

p_interactive <- p_interactive %>% 
  layout(hovermode = "closest")

# Display the plot
p_interactive

```